# 📝 自定义策略编辑器使用指南

## 概述

自定义策略编辑器是一个类似**聚宽平台**的策略编写工具，允许您使用Python代码自由编写量化交易策略，并通过简单的配置进行回测。

---

## 快速开始

### 1. 访问编辑器

```
主界面 → 侧边栏 → 选择功能模式 → 📝 自定义策略
```

### 2. 策略代码结构

每个策略必须包含两个函数：

```python
def initialize(context):
    '''
    初始化函数，只运行一次
    用于设置股票池、策略参数等
    '''
    context.symbols = ['股票代码1', '股票代码2']
    context.参数1 = 值
    # ... 其他参数

def handle_data(context):
    '''
    策略逻辑函数
    返回交易信号和策略配置
    '''
    return {
        'select_buy': ['买入条件表达式'],
        'select_sell': ['卖出条件表达式'],
        'order_by_signal': '排序因子表达式',
        'order_by_topK': 持仓数量,
        'weight': '加权方式',
        'period': '调仓周期'
    }
```

---

## 详细说明

### context 对象属性

| 属性 | 说明 | 示例 |
|------|------|------|
| `symbols` | 股票池（必填） | `['600519.SH', '000001.SZ']` |
| `start_date` | 回测开始日期 | `'20150101'` |
| `end_date` | 回测结束日期 | `'20240101'` |
| `benchmark` | 基准指数 | `'000300.SH'` (沪深300) |
| 自定义参数 | 策略参数 | `context.ma_period = 20` |

### 股票代码格式

- **上交所**：`代码.SH` (如: `600519.SH` - 贵州茅台)
- **深交所**：`代码.SZ` (如: `000001.SZ` - 平安银行)
- **创业板**：`300xxx.SZ` (如: `300750.SZ` - 宁德时代)
- **科创板**：`688xxx.SH` (如: `688981.SH` - 中芯国际)

### handle_data 返回值说明

#### 1. select_buy (买入条件)

买入信号表达式列表，支持多个条件组合：

```python
'select_buy': [
    "ma(close, 5) > ma(close, 20)",  # 条件1：短期均线上穿长期均线
    "rsi(close, 14) < 30"             # 条件2：RSI超卖
]
```

- 默认：所有条件都满足才买入
- 通过 `buy_at_least_count` 控制最少满足条件数

#### 2. select_sell (卖出条件)

卖出信号表达式列表：

```python
'select_sell': [
    "ma(close, 5) < ma(close, 20)",  # 短期均线下穿长期均线
    "rsi(close, 14) > 70"             # RSI超买
]
```

- 默认：满足任一条件即卖出
- 通过 `sell_at_least_count` 控制最少满足条件数

#### 3. order_by_signal (排序因子)

用于对股票池排序，选择得分最高的标的：

```python
'order_by_signal': 'roc(close, 20)'  # 按20日涨跌幅排序
```

#### 4. order_by_topK (持仓数量)

持仓股票数量：

```python
'order_by_topK': 5  # 持有前5只股票
```

#### 5. weight (加权方式)

| 加权方式 | 说明 | 适用场景 |
|---------|------|---------|
| `WeighEqually` | 等权重 | 通用策略 |
| `WeighERC` | 风险平价 | 多资产配置 |
| `WeighInvVol` | 波动率倒数 | 控制风险 |
| `WeighSpecified` | 指定权重 | 需配合 `weight_fixed` |

#### 6. period (调仓周期)

| 调仓周期 | 说明 | 适用场景 |
|---------|------|---------|
| `RunDaily` | 每日调仓 | 日内策略 |
| `RunWeekly` | 每周调仓 | 中短期策略 |
| `RunMonthly` | 每月调仓 | 中长期策略 |
| `RunQuarterly` | 每季度调仓 | 长期配置 |
| `RunYearly` | 每年调仓 | 资产配置 |

---

## 因子表达式参考

### 均线类

| 表达式 | 说明 | 示例 |
|--------|------|------|
| `ma(close, N)` | N日简单移动平均 | `ma(close, 20)` |
| `ema(close, N)` | N日指数移动平均 | `ema(close, 12)` |

### 动量类

| 表达式 | 说明 | 示例 |
|--------|------|------|
| `roc(close, N)` | N日涨跌幅 | `roc(close, 20)` |
| `mom(close, N)` | N日动量 | `mom(close, 10)` |

### 技术指标

| 表达式 | 说明 | 返回值 | 示例 |
|--------|------|-------|------|
| `rsi(close, N)` | N日RSI相对强弱指标 | 单值 | `rsi(close, 14)` |
| `macd(close, fast, slow, signal)` | MACD指标 | (DIF, DEA, MACD) | `macd(close, 12, 26, 9)` |
| `kdj(high, low, close, N, M1, M2)` | KDJ随机指标 | (K, D, J) | `kdj(high, low, close, 9, 3, 3)` |
| `boll(close, N, std)` | 布林带 | (上轨, 中轨, 下轨) | `boll(close, 20, 2)` |

### 多返回值使用

对于返回多个值的因子（如MACD、KDJ），使用 `[索引]` 访问：

```python
# MACD金叉：DIF上穿DEA
"macd(close, 12, 26, 9)[0] > macd(close, 12, 26, 9)[1]"

# 布林上轨突破
"close > boll(close, 20, 2)[0]"

# KDJ金叉
"kdj(high, low, close, 9, 3, 3)[0] > kdj(high, low, close, 9, 3, 3)[1]"
```

### 逻辑运算

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `>` | 大于 | `ma(close, 5) > ma(close, 20)` |
| `<` | 小于 | `rsi(close, 14) < 30` |
| `>=` | 大于等于 | `volume >= 1000000` |
| `<=` | 小于等于 | `close <= boll(close, 20, 2)[2]` |

---

## 策略示例

### 示例1: 双均线策略

```python
def initialize(context):
    context.symbols = ['600519.SH', '000858.SZ', '600036.SH']
    context.short_ma = 5
    context.long_ma = 20
    context.hold_count = 2

def handle_data(context):
    return {
        'select_buy': [f"ma(close, {context.short_ma}) > ma(close, {context.long_ma})"],
        'select_sell': [f"ma(close, {context.short_ma}) < ma(close, {context.long_ma})"],
        'order_by_signal': f'roc(close, {context.short_ma})',
        'order_by_topK': context.hold_count,
        'weight': 'WeighEqually',
        'period': 'RunDaily'
    }
```

**策略说明**：
- 买入：5日均线上穿20日均线
- 卖出：5日均线下穿20日均线
- 持仓：动量最强的前2只股票
- 调仓：每日

### 示例2: ETF动量轮动

```python
def initialize(context):
    context.symbols = [
        '518880.SH',  # 黄金ETF
        '513100.SH',  # 纳指ETF
        '159915.SZ',  # 创业板ETF
        '512100.SH'   # 中证1000
    ]
    context.momentum_days = 20
    context.hold_count = 2

def handle_data(context):
    return {
        'select_buy': [],  # 无条件，全选
        'select_sell': [],
        'order_by_signal': f'roc(close, {context.momentum_days})',
        'order_by_topK': context.hold_count,
        'weight': 'WeighEqually',
        'period': 'RunWeekly'
    }
```

**策略说明**：
- 无买卖信号（即始终持仓）
- 按20日涨幅排序
- 持仓动量最强的前2只ETF
- 每周调仓

### 示例3: RSI超卖反弹

```python
def initialize(context):
    context.symbols = ['300001.SZ', '300002.SZ', '300003.SZ', '300059.SZ', '300124.SZ']
    context.rsi_oversold = 30
    context.rsi_overbought = 70
    context.hold_count = 3

def handle_data(context):
    return {
        'select_buy': [f"rsi(close, 14) < {context.rsi_oversold}"],
        'select_sell': [f"rsi(close, 14) > {context.rsi_overbought}"],
        'order_by_signal': 'roc(close, 5)',
        'order_by_topK': context.hold_count,
        'weight': 'WeighEqually',
        'period': 'RunDaily'
    }
```

**策略说明**：
- 买入：RSI < 30（超卖）
- 卖出：RSI > 70（超买）
- 持仓：短期动量最强的前3只
- 调仓：每日

### 示例4: 多因子复合

```python
def initialize(context):
    context.symbols = ['600519.SH', '000858.SZ', '600036.SH', '601318.SH', '600276.SH']
    context.hold_count = 3

def handle_data(context):
    buy_conditions = [
        "roc(close, 20) > 0",  # 条件1：正收益
        "rsi(close, 14) < 40",  # 条件2：RSI不高
        "ma(close, 5) > ma(close, 20)"  # 条件3：短期向上
    ]

    return {
        'select_buy': buy_conditions,
        'buy_at_least_count': 2,  # 至少满足2个条件
        'select_sell': ["rsi(close, 14) > 75"],
        'order_by_signal': 'roc(close, 20)',
        'order_by_topK': context.hold_count,
        'weight': 'WeighEqually',
        'period': 'RunWeekly'
    }
```

**策略说明**：
- 买入：三个条件至少满足2个
- 卖出：RSI > 75 (严重超买)
- 持仓：按20日动量排序，前3只
- 调仓：每周

---

## 使用流程

### 步骤1: 编写策略

1. 点击右侧"策略模板"选择模板（或从空白开始）
2. 在代码编辑区编写/修改策略代码
3. 点击"验证代码"检查语法

### 步骤2: 配置参数

1. 选择数据源（推荐：💾 本地CSV）
2. 设置回测时间范围（如：2015-01-01 至今）
3. 选择基准指数（默认：000300.SH 沪深300）

### 步骤3: 运行回测

1. 点击"🚀 运行回测"按钮
2. 等待回测完成（10-30秒）
3. 查看回测结果

### 步骤4: 分析结果

回测结果包含：
- **关键指标卡片**：总收益、年化收益、最大回撤、夏普比率
- **累计收益曲线**：策略vs基准对比图
- **详细统计表格**：完整绩效指标
- **交易记录**：所有交易明细（可下载CSV）

---

## 注意事项

### 1. 数据源选择

- **本地CSV**：需先在"💾 AI数据管理"更新数据，适合长期历史回测
- **Ashare/Tushare/AKShare**：在线数据，暂未完全支持（开发中）

### 2. 股票池大小

- ETF策略：建议4-10只
- 个股策略：建议10-30只
- 股票池过大会影响回测速度

### 3. 代码安全

- 代码在隔离环境中执行
- 仅能访问策略相关API
- 不支持网络请求、文件读写等操作

### 4. 性能优化

- 使用简单因子表达式
- 避免复杂嵌套计算
- 合理设置调仓周期（避免过度交易）

---

## 常见问题

### Q1: 提示"错误：未设置股票池"

**A**: 确保在 `initialize()` 中设置了 `context.symbols`：

```python
def initialize(context):
    context.symbols = ['600519.SH']  # 至少一只股票
```

### Q2: 回测失败"数据路径不存在"

**A**:
1. 选择"💾 AI数据管理"功能
2. 点击"开始更新"下载股票数据
3. 等待数据更新完成（首次需1-2小时）

### Q3: 因子表达式报错

**A**: 检查：
- 函数名大小写（支持大小写，如 `ma` 或 `MA`）
- 参数数量是否正确
- 多返回值是否使用了 `[索引]`

### Q4: 如何保存策略代码？

**A**:
- 代码自动保存在当前会话（刷新会丢失）
- 建议复制到本地文件保存
- 或使用浏览器书签收藏

---

## 技术支持

- **项目仓库**：[aytradingstrategy](https://github.com/Ecustkiller/aytradingstragegy)
- **反馈问题**：提交 GitHub Issue
- **交流讨论**：查看项目 README

---

## 更新日志

### v1.0.0 (2024-11-11)
- ✅ 初版发布
- ✅ 支持自定义Python策略代码
- ✅ 5种内置策略模板
- ✅ 本地CSV数据源回测
- ✅ 完整回测结果展示
- ✅ 交易记录CSV导出

---

**祝您使用愉快！** 🎉
