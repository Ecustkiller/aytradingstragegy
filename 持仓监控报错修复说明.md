# 持仓监控报错修复说明

## 🐛 问题描述

在持仓监控页面点击"刷新行情"时出现错误：
```
未获取到任何行情数据
❌ 获取行情数据失败
```

## 🔍 问题原因

`get_realtime_quotes_sina()` 函数在处理纯数字股票代码（如 `000001`、`600519`）时，没有正确添加市场前缀（`sh`/`sz`），导致新浪接口无法识别股票代码。

**问题代码：**
```python
# 旧的格式化逻辑（有问题）
xcode = 'sh' + xcode if ('XSHG' in code) else 'sz' + xcode if ('XSHE' in code) else code
# 当传入 '000001' 时，xcode 仍然是 '000001'，没有添加 'sz' 前缀
```

## ✅ 修复方案

修改了 `get_realtime_quotes_sina()` 函数中的代码格式化逻辑，增加了对纯数字代码的处理：

```python
# 新的格式化逻辑（已修复）
for code in codes_list:
    xcode = code.replace('.XSHG', '').replace('.XSHE', '')
    
    # 如果已经有前缀，直接使用
    if xcode.startswith('sh') or xcode.startswith('sz'):
        formatted_codes.append(xcode)
    # 如果是聚宽格式，转换
    elif 'XSHG' in code:
        formatted_codes.append('sh' + xcode)
    elif 'XSHE' in code:
        formatted_codes.append('sz' + xcode)
    # 纯数字，根据规则判断市场
    elif xcode.isdigit():
        if xcode.startswith('6'):
            formatted_codes.append('sh' + xcode)  # 60开头是上海主板
        elif xcode.startswith('0') or xcode.startswith('3'):
            formatted_codes.append('sz' + xcode)  # 00开头是深圳主板，30开头是创业板
        else:
            formatted_codes.append(xcode)
    else:
        formatted_codes.append(xcode)
```

## 📝 修改的文件

1. **modules/Ashare.py** - 修复 `get_realtime_quotes_sina()` 函数
2. **aitrader_core/datafeed/Ashare.py** - 同步修复

## 🧪 测试结果

### 修复前：
```bash
测试1: 传入纯数字代码
输入代码: ['000001', '600519']
返回结果: {}  # ❌ 空结果
是否为空: True
```

### 修复后：
```bash
测试1: 传入纯数字代码
输入代码: ['000001', '600519']
返回结果: {
    'sz000001': {'name': '平安银行', 'current_price': 11.63, ...},
    'sh600519': {'name': '贵州茅台', 'current_price': 1462.3, ...}
}  # ✅ 成功获取
是否为空: False
```

### 完整测试：
```bash
python3 test_portfolio_monitor.py

✅ 测试1: 获取股票名称 - 通过
✅ 测试2: 获取实时行情 - 通过
✅ 测试3: 批量获取行情 - 通过
```

## 🎯 现在可以正常使用

1. 打开 Streamlit 应用
2. 进入"📊 持仓监控"页面
3. 添加股票（只需输入代码，如 `000001`）
4. 点击"🔄 刷新行情"
5. ✅ 成功显示实时行情数据

## 📊 支持的代码格式

现在所有格式都能正常工作：

| 格式 | 示例 | 说明 |
|------|------|------|
| 纯数字 | `000001` | ✅ 自动识别为深圳 |
| 纯数字 | `600519` | ✅ 自动识别为上海 |
| 纯数字 | `300750` | ✅ 自动识别为创业板 |
| 带前缀 | `sh000001` | ✅ 直接使用 |
| 带前缀 | `sz000001` | ✅ 直接使用 |
| 聚宽格式 | `000001.XSHG` | ✅ 转换为sh000001 |
| 聚宽格式 | `600519.XSHG` | ✅ 转换为sh600519 |

## 🔧 调试工具

如果遇到问题，可以运行调试脚本：

```bash
python3 debug_portfolio.py
```

这个脚本会测试纯数字代码和带前缀代码的获取情况，帮助快速定位问题。

---

**修复时间：** 2025-11-11  
**问题状态：** ✅ 已解决
