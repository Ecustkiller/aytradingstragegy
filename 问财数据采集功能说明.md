# 📊 问财数据采集功能说明

## 功能概述

问财数据采集是一个强大的历史股票数据批量采集工具，通过问财（同花顺财经）接口，可以快速采集A股市场的各类数据。

## 主要特性

### 1. 智能查询模板系统
- **日期变量替换**：支持 `${current_date}`, `${pre1}`, `${pre2}`, `${pre3}` 等日期变量
  - `${current_date}`: 当前日期
  - `${pre1}`, `${pre2}`, `${pre3}`: 前1/2/3个交易日
  - `${next1}`, `${next2}`, `${next3}`: 后1/2/3个交易日
  - `${week_start}`: 本周第一天
  - `${month_start}`: 本月第一天

### 2. 预设查询模板
- **涨停股票分析**: `${current_date}涨停,${current_date}原因,概念`
- **指数成分股**: `${current_date}上证50成分股`
- **行业龙头**: `${current_date}行业龙头`
- **新高突破**: `${current_date}创60日新高,成交量>1亿`
- **强势股**: `${current_date}5日涨幅>10%,换手率>5%`

### 3. 批量数据采集
- 按交易日循环采集数据
- 智能跳过节假日和周末（需要 `chinesecalendar` 库）
- 支持股票和指数两种查询类型
- 带进度条和实时日志反馈

### 4. 数据处理
- 自动清理列名（去除日期戳）
- 去重和排序（按股票代码和数据日期）
- 合并所有临时文件
- 导出为 Excel 格式

### 5. 高级功能
- **请求间隔控制**: 防止被限流（默认3-5秒）
- **专业版支持**: 可配置问财专业版 Cookie
- **代理支持**: 支持 HTTP/HTTPS 代理
- **临时文件管理**: 可选择保留或清除临时文件

## 使用方法

### 1. 基本使用流程
1. 在主界面选择 "📊 问财数据采集" 功能模式
2. 设置开始日期和结束日期
3. 选择预设查询模板或自定义查询
4. 选择查询类型（stock 或 zhishu）
5. 点击 "开始采集" 按钮
6. 等待采集完成后下载结果

### 2. 自定义查询示例

**查询涨停股票并获取概念信息**:
```
${current_date}涨停,${current_date}原因,概念
```

**查询创新高的股票**:
```
${current_date}创60日新高,成交量>1亿,流通市值<100亿
```

**查询某个板块的龙头股**:
```
${current_date}新能源汽车概念,${current_date}行业龙头
```

**查询技术突破股票**:
```
${current_date}突破布林上轨,${current_date}MACD金叉,成交量放大
```

### 3. 高级选项

#### 请求间隔
- 建议范围：3-5秒
- 过短可能被限流，过长则采集效率低

#### 专业版功能
如果你有问财专业版账号：
1. 勾选 "使用专业版"
2. 填入你的专业版 Cookie
3. 可以获得更多数据和更高的请求频率

#### 代理配置
如果需要通过代理访问：
1. 勾选 "启用代理"
2. 填入 HTTP 和 HTTPS 代理地址
   - 格式：`http://proxy.example.com:8080`

## 依赖库

### 必需依赖
- `pywencai`: 问财接口库
- `pandas`: 数据处理
- `openpyxl`: Excel 文件读写

### 可选依赖
- `chinesecalendar`: 中国节假日判断（强烈推荐）

### 安装命令
```bash
pip install pywencai pandas openpyxl
pip install chinesecalendar  # 可选但推荐
```

## 输出格式

采集的数据将保存为 Excel 文件（`.xlsx`），包含以下特点：

1. **数据日期列**: 每条记录都会标注数据采集的日期
2. **去重处理**: 自动去除重复记录（按股票代码和日期）
3. **排序**: 按数据日期升序排列
4. **列名清理**: 自动清除列名中的日期戳

示例输出格式：
| 数据日期 | 股票代码 | 股票简称 | 涨跌幅 | 成交量 | 概念 |
|---------|---------|---------|--------|--------|------|
| 20251028 | 600519.SH | 贵州茅台 | 2.5% | 1000万 | 白酒 |
| 20251028 | 000858.SZ | 五粮液 | 3.2% | 1500万 | 白酮 |

## 注意事项

1. **请求频率**: 请合理设置请求间隔，避免频繁请求被限流
2. **数据准确性**: 数据来源于问财接口，以实际网站为准
3. **macOS 兼容性**: 如果 `pywencai` 在 macOS 上出现问题，已内置友好的错误提示
4. **磁盘空间**: 大量数据采集可能占用较多磁盘空间，注意预留空间
5. **网络稳定性**: 建议在网络稳定的环境下进行数据采集

## 常见问题

### Q1: 提示 "pywencai 模块不可用"
**A**: 需要安装 `pywencai` 库：
```bash
pip install pywencai
```

### Q2: 采集速度很慢
**A**: 
- 检查请求间隔设置，可以适当缩短（但不要低于1秒）
- 检查网络连接
- 考虑使用专业版账号提高速度

### Q3: 某些日期没有数据
**A**: 
- 可能是节假日或非交易日
- 查询条件可能过于严格，导致无结果
- 问财接口本身可能无数据

### Q4: 提示 "未安装 chinese_calendar 库"
**A**: 这不影响基本功能，但建议安装以获得更准确的交易日判断：
```bash
pip install chinesecalendar
```

### Q5: 如何获取问财专业版 Cookie
**A**: 
1. 登录问财专业版网站
2. 打开浏览器开发者工具（F12）
3. 在 Network 标签中找到请求
4. 复制 Cookie 字段的内容

## 使用技巧

### 1. 批量查询多个指标
可以在一次查询中获取多个指标：
```
${current_date}涨停,${current_date}涨停原因,${current_date}所属概念,${current_date}流通市值,${current_date}成交额
```

### 2. 时间序列分析
通过设置较长的日期范围，可以进行时间序列分析：
- 开始日期：2024-01-01
- 结束日期：2024-12-31
- 查询：`${current_date}上证50成分股,${current_date}收盘价,${current_date}成交量`

### 3. 相对日期查询
利用日期变量进行相对日期查询：
```
${current_date}涨停,${pre1}涨停,连续2日涨停
```

### 4. 组合条件筛选
```
${current_date}创60日新高,${current_date}成交量>前5日平均成交量*2,${current_date}流通市值<100亿
```

## 更新历史

- **v1.0** (2025-10-29): 初始版本，集成到主应用
  - 支持基本的数据采集功能
  - 智能日期变量替换
  - 进度条和日志反馈
  - Excel 导出和预览

## 技术支持

如遇到问题，请检查：
1. 依赖库是否正确安装
2. 网络连接是否正常
3. 查询语法是否正确
4. 问财接口是否可用

---

**祝你使用愉快！** 🎉

