# ðŸŽ¯ è‡ªå®šä¹‰ç­–ç•¥ç¼–è¾‘å™¨ - åŠŸèƒ½å®žçŽ°è¯´æ˜Ž

## æ¦‚è¿°

æˆåŠŸä¸º AY Trading Strategy é¡¹ç›®æ·»åŠ äº†**ç±»èšå®½å¹³å°**çš„è‡ªå®šä¹‰ç­–ç•¥ç¼–è¾‘å™¨åŠŸèƒ½ï¼Œæ”¯æŒåœ¨çº¿ç¼–å†™Pythonç­–ç•¥ä»£ç å¹¶è¿›è¡Œå›žæµ‹ã€‚

---

## âœ¨ å®žçŽ°çš„åŠŸèƒ½

### 1. æ ¸å¿ƒåŠŸèƒ½
- âœ… **åœ¨çº¿ä»£ç ç¼–è¾‘å™¨** - ä½¿ç”¨ Streamlit `text_area` æä¾›å¤§å°ºå¯¸ä»£ç ç¼–è¾‘åŒº
- âœ… **ç­–ç•¥ä»£ç è§£æžå¼•æ“Ž** - ä½¿ç”¨ `exec()` å®‰å…¨æ‰§è¡Œç”¨æˆ·ä»£ç 
- âœ… **ç­–ç•¥APIè®¾è®¡** - ç±»èšå®½çš„ `initialize()` å’Œ `handle_data()` æŽ¥å£
- âœ… **å‚æ•°é…ç½®ç•Œé¢** - æ•°æ®æºã€æ—¶é—´èŒƒå›´ã€åŸºå‡†æŒ‡æ•°é€‰æ‹©
- âœ… **ä¸€é”®å›žæµ‹** - è°ƒç”¨çŽ°æœ‰ `bt_engine.Engine` æ‰§è¡Œå›žæµ‹
- âœ… **ç»“æžœå¯è§†åŒ–** - æ”¶ç›Šæ›²çº¿ã€å›žæ’¤åˆ†æžã€è¯¦ç»†ç»Ÿè®¡
- âœ… **äº¤æ˜“è®°å½•å¯¼å‡º** - CSVæ ¼å¼å®Œæ•´äº¤æ˜“æ˜Žç»†

### 2. ç­–ç•¥æ¨¡æ¿åº“ï¼ˆ5ç§ï¼‰
1. **å‡çº¿ç­–ç•¥** - ç»å…¸åŒå‡çº¿é‡‘å‰æ­»å‰
2. **åŠ¨é‡è½®åŠ¨ç­–ç•¥** - ETFåŠ¨é‡è¯„åˆ†è½®åŠ¨
3. **çªç ´ç­–ç•¥** - å¸ƒæž—å¸¦çªç ´ç³»ç»Ÿ
4. **é£Žé™©å¹³ä»·ç­–ç•¥** - å¤šèµ„äº§é£Žé™©å¹³ä»·é…ç½®
5. **å¤šå› å­é€‰è‚¡** - å¤åˆå› å­ç­›é€‰ç³»ç»Ÿ

### 3. å› å­è¡¨è¾¾å¼æ”¯æŒ
- å‡çº¿ç±»ï¼š`ma()`, `ema()`
- åŠ¨é‡ç±»ï¼š`roc()`, `mom()`
- æŠ€æœ¯æŒ‡æ ‡ï¼š`rsi()`, `macd()`, `kdj()`, `boll()`
- é€»è¾‘è¿ç®—ï¼š`>`, `<`, `>=`, `<=`

---

## ðŸ“ æ–°å¢žæ–‡ä»¶

### 1. æ ¸å¿ƒæ¨¡å—
```
modules/custom_strategy_editor.py (500è¡Œ)
```
- `StrategyContext` - ç­–ç•¥ä¸Šä¸‹æ–‡ç±»
- `execute_strategy_code()` - ä»£ç è§£æžæ‰§è¡Œå‡½æ•°
- `run_backtest_with_task()` - å›žæµ‹æ‰§è¡Œå‡½æ•°
- `display_custom_strategy_editor()` - Streamlitç•Œé¢å‡½æ•°
- `display_backtest_results()` - ç»“æžœå±•ç¤ºå‡½æ•°
- `STRATEGY_TEMPLATES` - 5ç§ç­–ç•¥æ¨¡æ¿å­—å…¸

### 2. æ–‡æ¡£
```
è‡ªå®šä¹‰ç­–ç•¥ç¼–è¾‘å™¨ä½¿ç”¨æŒ‡å—.md (å®Œæ•´ç”¨æˆ·æ‰‹å†Œ)
è‡ªå®šä¹‰ç­–ç•¥åŠŸèƒ½è¯´æ˜Ž.md (æœ¬æ–‡ä»¶)
test_custom_strategy.py (æµ‹è¯•è„šæœ¬)
```

### 3. ä¿®æ”¹çš„æ–‡ä»¶
```
modules/frontend.py - æ·»åŠ ã€ŒðŸ“ è‡ªå®šä¹‰ç­–ç•¥ã€é€‰é¡¹
modules/app.py - æ·»åŠ è·¯ç”±é€»è¾‘
README.md - æ›´æ–°ä½¿ç”¨æŒ‡å—
```

---

## ðŸ”§ æŠ€æœ¯å®žçŽ°

### æž¶æž„è®¾è®¡

```
ç”¨æˆ·ä»£ç  (Python)
    â†“
StrategyContext (ä¸Šä¸‹æ–‡å¯¹è±¡)
    â†“
execute_strategy_code() (è§£æž&éªŒè¯)
    â†“
Task (é…ç½®å¯¹è±¡)
    â†“
Engine.run() (å›žæµ‹å¼•æ“Ž)
    â†“
Result (ç»“æžœå¯¹è±¡)
    â†“
display_backtest_results() (å¯è§†åŒ–)
```

### å…³é”®æŠ€æœ¯ç‚¹

#### 1. ä»£ç å®‰å…¨æ‰§è¡Œ
```python
# åˆ›å»ºéš”ç¦»å‘½åç©ºé—´
namespace = {}
exec(code_str, namespace)

# éªŒè¯å¿…è¦å‡½æ•°
if 'initialize' not in namespace:
    return None, "é”™è¯¯ï¼šç¼ºå°‘ initialize() å‡½æ•°"
```

#### 2. APIè®¾è®¡
```python
class StrategyContext:
    def __init__(self):
        self.symbols = []  # è‚¡ç¥¨æ± 
        self.start_date = '20150101'
        self.end_date = datetime.now().strftime('%Y%m%d')
        self.benchmark = '000300.SH'
```

ç”¨æˆ·ä»£ç é€šè¿‡ä¿®æ”¹ `context` å±žæ€§æ¥é…ç½®ç­–ç•¥ã€‚

#### 3. ç­–ç•¥å‚æ•°è½¬æ¢
```python
# ç”¨æˆ·ä»£ç è¿”å›žå­—å…¸
strategy_params = {
    'select_buy': ['ma(close, 5) > ma(close, 20)'],
    'order_by_signal': 'roc(close, 20)',
    'order_by_topK': 2,
    'weight': 'WeighEqually',
    'period': 'RunDaily'
}

# è½¬æ¢ä¸º Task å¯¹è±¡
task = Task()
task.select_buy = strategy_params.get('select_buy', [])
task.order_by_signal = strategy_params.get('order_by_signal', '')
# ... å…¶ä»–å‚æ•°
```

#### 4. å›žæµ‹å¼•æ“Žå¤ç”¨
ç›´æŽ¥è°ƒç”¨çŽ°æœ‰çš„ `bt_engine.Engine`ï¼š
```python
from bt_engine import Engine

engine = Engine(path=str(data_path))
result = engine.run(task, commissions=commissions)
```

---

## ðŸŽ¨ ç•Œé¢è®¾è®¡

### å¸ƒå±€ç»“æž„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ“ è‡ªå®šä¹‰ç­–ç•¥ç¼–è¾‘å™¨                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ä½¿ç”¨è¯´æ˜ŽæŠ˜å æ¡†]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚  ðŸ“š ç­–ç•¥æ¨¡æ¿      â”‚
â”‚   ðŸ’» ç­–ç•¥ä»£ç         â”‚  [æ¨¡æ¿é€‰æ‹©å™¨]     â”‚
â”‚   [å¤§åž‹æ–‡æœ¬æ¡†]       â”‚  [åŠ è½½æ¨¡æ¿æŒ‰é’®]   â”‚
â”‚                     â”‚                  â”‚
â”‚                     â”‚  âš™ï¸ å›žæµ‹å‚æ•°      â”‚
â”‚                     â”‚  - æ•°æ®æº         â”‚
â”‚   [éªŒè¯] [æ¸…ç©º]     â”‚  - å¼€å§‹æ—¥æœŸ       â”‚
â”‚                     â”‚  - ç»“æŸæ—¥æœŸ       â”‚
â”‚                     â”‚  - åŸºå‡†æŒ‡æ•°       â”‚
â”‚                     â”‚                  â”‚
â”‚                     â”‚  [ðŸš€ è¿è¡Œå›žæµ‹]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»“æžœå±•ç¤º
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ“Š å›žæµ‹ç»“æžœ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ€»æ”¶ç›Š] [å¹´åŒ–æ”¶ç›Š] [æœ€å¤§å›žæ’¤] [å¤æ™®]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ“ˆ ç´¯è®¡æ”¶ç›Šæ›²çº¿å›¾                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ“‹ è¯¦ç»†ç»Ÿè®¡è¡¨æ ¼                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ“ äº¤æ˜“è®°å½•è¡¨æ ¼  [ðŸ“¥ ä¸‹è½½CSV]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ§ª æµ‹è¯•ç»“æžœ

### æµ‹è¯•è„šæœ¬æ‰§è¡Œç»“æžœ
```bash
$ python3 test_custom_strategy.py

âœ… æµ‹è¯•1: ç­–ç•¥ä»£ç è§£æž - é€šè¿‡
âœ… æµ‹è¯•3: éªŒè¯æ‰€æœ‰ç­–ç•¥æ¨¡æ¿ - 5/5 é€šè¿‡
âš ï¸  æµ‹è¯•2: å›žæµ‹æ‰§è¡Œ - è·³è¿‡ï¼ˆç¼ºå°‘æ•°æ®ï¼‰
```

### éªŒè¯é¡¹
- âœ… ä»£ç è§£æžå¼•æ“Žæ­£å¸¸
- âœ… Taskå¯¹è±¡æž„å»ºæ­£ç¡®
- âœ… 5ç§ç­–ç•¥æ¨¡æ¿è¯­æ³•æ— è¯¯
- âš ï¸ å›žæµ‹éœ€è¦å…ˆåœ¨"AIæ•°æ®ç®¡ç†"ä¸­æ›´æ–°æ•°æ®

---

## ðŸ“š ä½¿ç”¨æµç¨‹

### å¿«é€Ÿä¸Šæ‰‹
1. å¯åŠ¨åº”ç”¨ï¼š`streamlit run streamlit_app.py`
2. é€‰æ‹©åŠŸèƒ½ï¼šä¾§è¾¹æ  â†’ `ðŸ“ è‡ªå®šä¹‰ç­–ç•¥`
3. é€‰æ‹©æ¨¡æ¿ï¼šå³ä¾§ â†’ ç­–ç•¥æ¨¡æ¿ â†’ é€‰æ‹© â†’ åŠ è½½æ¨¡æ¿
4. ä¿®æ”¹ä»£ç ï¼šå·¦ä¾§ä»£ç ç¼–è¾‘å™¨ä¸­è°ƒæ•´å‚æ•°
5. è®¾ç½®å‚æ•°ï¼šå³ä¾§ â†’ æ•°æ®æºã€æ—¶é—´èŒƒå›´
6. è¿è¡Œå›žæµ‹ï¼šç‚¹å‡» `ðŸš€ è¿è¡Œå›žæµ‹`
7. æŸ¥çœ‹ç»“æžœï¼šæ”¶ç›Šæ›²çº¿ã€äº¤æ˜“è®°å½•ç­‰

### æ•°æ®å‡†å¤‡ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
```
ä¸»ç•Œé¢ â†’ ðŸ’¾ AIæ•°æ®ç®¡ç† â†’ å¼€å§‹æ›´æ–°
```
ç­‰å¾…1-2å°æ—¶ä¸‹è½½5600+åªAè‚¡æ•°æ®åˆ°æœ¬åœ°ã€‚

---

## ðŸ” ç¤ºä¾‹ä»£ç 

### æœ€ç®€ç­–ç•¥
```python
def initialize(context):
    context.symbols = ['159915.SZ']  # åˆ›ä¸šæ¿ETF

def handle_data(context):
    return {
        'select_buy': [],
        'select_sell': [],
        'order_by_signal': '',
        'order_by_topK': 0,
        'weight': 'WeighEqually',
        'period': 'RunMonthly'
    }
```

### åŒå‡çº¿ç­–ç•¥
```python
def initialize(context):
    context.symbols = ['600519.SH', '000858.SZ']
    context.short_ma = 5
    context.long_ma = 20

def handle_data(context):
    return {
        'select_buy': [f"ma(close, {context.short_ma}) > ma(close, {context.long_ma})"],
        'select_sell': [f"ma(close, {context.short_ma}) < ma(close, {context.long_ma})"],
        'order_by_signal': 'roc(close, 10)',
        'order_by_topK': 1,
        'weight': 'WeighEqually',
        'period': 'RunDaily'
    }
```

---

## ðŸš€ æœªæ¥æ‰©å±•

### è®¡åˆ’åŠŸèƒ½
1. **å¤šæ•°æ®æºæ”¯æŒ**
   - âœ… æœ¬åœ°CSVï¼ˆå·²æ”¯æŒï¼‰
   - â³ Ashareå®žæ—¶æ•°æ®
   - â³ Tushareä¸“ä¸šæ•°æ®
   - â³ AKShareåœ¨çº¿æ•°æ®

2. **ç­–ç•¥ä¿å­˜ä¸Žåˆ†äº«**
   - â³ ç­–ç•¥åº“ç®¡ç†ï¼ˆä¿å­˜/åŠ è½½ç­–ç•¥ï¼‰
   - â³ ç­–ç•¥åˆ†äº«ï¼ˆå¯¼å‡º/å¯¼å…¥.pyæ–‡ä»¶ï¼‰
   - â³ äº‘ç«¯ç­–ç•¥åº“

3. **é«˜çº§åŠŸèƒ½**
   - â³ ç­–ç•¥å‚æ•°ä¼˜åŒ–ï¼ˆç½‘æ ¼æœç´¢ï¼‰
   - â³ å›žæµ‹æ€§èƒ½åˆ†æžï¼ˆæ›´å¤šæŒ‡æ ‡ï¼‰
   - â³ å®žç›˜æ¨¡æ‹Ÿï¼ˆçº¸é¢äº¤æ˜“ï¼‰
   - â³ ç­–ç•¥å¯¹æ¯”ï¼ˆåŒæ—¶è¿è¡Œå¤šä¸ªç­–ç•¥ï¼‰

4. **ä»£ç ç¼–è¾‘å™¨å¢žå¼º**
   - â³ è¯­æ³•é«˜äº®ï¼ˆä½¿ç”¨ `streamlit-ace` æˆ– `streamlit-code-editor`ï¼‰
   - â³ ä»£ç è‡ªåŠ¨è¡¥å…¨
   - â³ é”™è¯¯æç¤ºé«˜äº®

---

## ðŸ“ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®æºé™åˆ¶
å½“å‰ç‰ˆæœ¬ä»…å®Œå…¨æ”¯æŒ**æœ¬åœ°CSVæ•°æ®æº**ï¼Œå…¶ä»–æ•°æ®æºï¼ˆAshare/Tushare/AKShareï¼‰çš„æŽ¥å£å·²é¢„ç•™ï¼Œä½†éœ€è¦è¿›ä¸€æ­¥å¼€å‘æ•°æ®åŠ è½½é€»è¾‘ã€‚

### 2. è‚¡ç¥¨ä»£ç æ ¼å¼
å¿…é¡»ä½¿ç”¨æ ‡å‡†æ ¼å¼ï¼š
- ä¸Šäº¤æ‰€ï¼š`ä»£ç .SH`
- æ·±äº¤æ‰€ï¼š`ä»£ç .SZ`

### 3. é¦–æ¬¡ä½¿ç”¨
å¿…é¡»å…ˆåœ¨"ðŸ’¾ AIæ•°æ®ç®¡ç†"æ›´æ–°æœ¬åœ°æ•°æ®ï¼Œå¦åˆ™å›žæµ‹ä¼šå¤±è´¥ã€‚

### 4. æ€§èƒ½å»ºè®®
- è‚¡ç¥¨æ± ä¸å®œè¿‡å¤§ï¼ˆå»ºè®®10-30åªï¼‰
- å›žæµ‹æ—¶é—´ä¸å®œè¿‡é•¿ï¼ˆå»ºè®®3-5å¹´ï¼‰
- è°ƒä»“å‘¨æœŸåˆç†è®¾ç½®ï¼ˆé¿å…è¿‡åº¦äº¤æ˜“ï¼‰

---

## ðŸ”— ç›¸å…³æ–‡æ¡£

- [è‡ªå®šä¹‰ç­–ç•¥ç¼–è¾‘å™¨ä½¿ç”¨æŒ‡å—.md](./è‡ªå®šä¹‰ç­–ç•¥ç¼–è¾‘å™¨ä½¿ç”¨æŒ‡å—.md) - ç”¨æˆ·æ‰‹å†Œ
- [README.md](./README.md) - é¡¹ç›®æ€»è§ˆ
- [AIåŠŸèƒ½é›†æˆæ€»ç»“.md](./AIåŠŸèƒ½é›†æˆæ€»ç»“.md) - AIåŠŸèƒ½è¯´æ˜Ž
- [æ•°æ®æºä½¿ç”¨è¯´æ˜Ž.md](./æ•°æ®æºä½¿ç”¨è¯´æ˜Ž.md) - æ•°æ®æºé…ç½®

---

## ðŸ“§ æŠ€æœ¯æ”¯æŒ

- **GitHub**: [@Ecustkiller](https://github.com/Ecustkiller)
- **ä»“åº“**: [aytradingstrategy](https://github.com/Ecustkiller/aytradingstragegy)
- **é—®é¢˜åé¦ˆ**: æäº¤ GitHub Issue

---

**å®žçŽ°å®Œæˆæ—¥æœŸ**: 2024-11-11
**ç‰ˆæœ¬**: v1.0.0
**çŠ¶æ€**: âœ… å¯ç”¨ (æœ¬åœ°CSVæ•°æ®æº)
