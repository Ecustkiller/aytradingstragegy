# 持仓监控功能更新说明

## 🎉 更新内容

### 1. 自动获取股票名称
现在添加股票时，**只需要输入股票代码**，系统会自动获取股票名称！

**支持的代码格式：**
- 纯数字：`000001`、`600519`、`300750`
- 带前缀：`sh000001`、`sz000001`
- 聚宽格式：`000001.XSHG`、`600519.XSHG`

**自动识别规则：**
- `6`开头 → 上海主板（如：600519 贵州茅台）
- `0`开头 → 深圳主板（如：000001 平安银行）
- `3`开头 → 创业板（如：300750 宁德时代）

### 2. 实时行情接口优化
使用新浪财经实时行情接口，获取更准确的实时数据：
- ✅ 真正的实时价格（延迟约15分钟）
- ✅ 批量获取，速度更快
- ✅ 包含完整的行情数据（开盘、最高、最低、成交量等）

### 3. 修复的问题
- ❌ 修复了 `name 'get_price' is not defined` 错误
- ❌ 修复了实时行情获取失败的问题
- ✅ 改进了代码格式化逻辑

## 📝 使用方法

### 添加股票到持仓

1. 在侧边栏找到"➕ 添加股票"
2. 输入股票代码（例如：`000001` 或 `600519`）
3. **股票名称可以留空**，系统会自动获取
4. 可选填写：成本价、持仓数量、买入日期
5. 点击"添加到持仓"

**示例：**
```
股票代码: 000001
股票名称: (留空)
成本价: 11.50
持仓数量: 1000
买入日期: 2025-11-10
```

系统会自动识别：`000001` → `平安银行`

### 查看实时行情

1. 点击"🔄 刷新行情"按钮
2. 或勾选"自动刷新"（每30秒更新一次）
3. 查看持仓概览和明细

## 🔧 技术细节

### 新增函数

#### `get_stock_name(stock_code)`
获取股票名称

```python
from Ashare import get_stock_name

# 支持多种格式
name = get_stock_name('000001')      # 平安银行
name = get_stock_name('600519')      # 贵州茅台
name = get_stock_name('sh000001')    # 上证指数
name = get_stock_name('600519.XSHG') # 贵州茅台
```

#### `get_realtime_quotes_sina(stock_codes)`
批量获取实时行情

```python
from Ashare import get_realtime_quotes_sina

# 批量获取
quotes = get_realtime_quotes_sina(['sz000001', 'sh600519', 'sz300750'])

# 返回格式
{
    'sz000001': {
        'name': '平安银行',
        'current_price': 11.63,
        'change': 0.08,
        'change_pct': 0.69,
        'open': 11.52,
        'high': 11.64,
        'low': 11.45,
        'volume': 82720833.0,
        'amount': 957555600.77,
        'time': '2025-11-10 15:00:00'
    },
    ...
}
```

### 数据来源

**新浪财经实时行情API：**
```
https://hq.sinajs.cn/rn={timestamp}&list={stock_codes}
```

**数据字段说明：**
- 字段0：股票名称
- 字段1：今日开盘价
- 字段2：昨日收盘价
- 字段3：当前价格
- 字段4：今日最高价
- 字段5：今日最低价
- 字段8：成交量（手）
- 字段9：成交额（元）
- 字段30-31：日期和时间

## 🧪 测试

运行测试脚本验证功能：

```bash
python3 test_portfolio_monitor.py
```

测试内容：
1. ✅ 获取股票名称（支持多种格式）
2. ✅ 获取实时行情（单个和批量）
3. ✅ 模拟持仓监控场景

## 📂 修改的文件

1. **modules/Ashare.py** - 添加实时行情和股票名称获取函数
2. **aitrader_core/datafeed/Ashare.py** - 同步更新
3. **modules/portfolio_monitor.py** - 优化持仓监控逻辑
4. **test_portfolio_monitor.py** - 新增测试脚本

## 🎯 下一步优化建议

1. 添加股票代码验证（检查代码是否有效）
2. 支持更多市场（港股、美股等）
3. 添加价格预警功能
4. 支持导入/导出持仓数据
5. 添加持仓分析图表

## 📞 问题反馈

如遇到问题，请检查：
1. 网络连接是否正常
2. 股票代码格式是否正确
3. 是否在交易时间内（实时数据延迟约15分钟）

---

**更新时间：** 2025-11-11  
**版本：** v1.1.0
