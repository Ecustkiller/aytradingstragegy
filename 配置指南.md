# 🔧 配置指南

本文档说明如何配置 AY Trading Strategy 系统的环境变量和相关设置。

---

## 📋 目录

1. [快速开始](#快速开始)
2. [环境变量配置](#环境变量配置)
3. [数据源配置](#数据源配置)
4. [通知配置](#通知配置)
5. [高级配置](#高级配置)
6. [常见问题](#常见问题)

---

## 🚀 快速开始

### 1. 复制配置文件

```bash
cp .env.example .env
```

### 2. 编辑配置文件

使用文本编辑器打开 `.env` 文件：

```bash
# macOS/Linux
nano .env

# Windows
notepad .env
```

### 3. 填入必要配置

最少需要配置 Tushare Token：

```bash
TUSHARE_TOKEN=your_tushare_token_here
```

### 4. 安装依赖

```bash
pip install -r requirements.txt
```

### 5. 启动应用

```bash
streamlit run streamlit_app.py
```

---

## 🔑 环境变量配置

### 必填配置

#### TUSHARE_TOKEN

**说明**：Tushare 专业版 API Token，用于获取高质量金融数据

**获取方式**：
1. 访问 [https://tushare.pro/register](https://tushare.pro/register)
2. 注册账号
3. 在个人中心获取 Token

**配置示例**：
```bash
TUSHARE_TOKEN=1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
```

**注意事项**：
- Token 是64位字符串
- 免费账号有积分限制，建议升级为付费用户
- 不要将 Token 提交到 Git 仓库

---

### 可选配置

#### 数据存储

```bash
# 股票数据存储目录（默认：项目下的 data/stock_data）
STOCK_DATA_DIR=/path/to/your/stock_data

# 缓存目录（默认：data_cache）
CACHE_DIR=data_cache
```

#### 通知配置

```bash
# 企业微信 Webhook URL
WECOM_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your_key

# 钉钉 Webhook URL
DINGTALK_WEBHOOK_URL=https://oapi.dingtalk.com/robot/send?access_token=your_token
```

**获取 Webhook URL**：
- 企业微信：群聊 → 群机器人 → 添加机器人 → 复制 Webhook 地址
- 钉钉：群设置 → 智能群助手 → 添加机器人 → 复制 Webhook 地址

#### 应用配置

```bash
# 日志级别（DEBUG/INFO/WARNING/ERROR）
LOG_LEVEL=INFO

# 日志保留天数
LOG_RETENTION_DAYS=30

# 缓存过期时间（分钟）
CACHE_TTL_MINUTES=30

# 每分钟最大请求数（防止被限流）
MAX_REQUESTS_PER_MINUTE=15
```

#### 开发配置

```bash
# 开发模式（显示更多调试信息）
DEBUG=False

# Streamlit 端口
STREAMLIT_PORT=8501
```

---

## 📊 数据源配置

系统支持 4 种数据源：

### 1. 本地 CSV（Baostock）

**优点**：
- 速度最快
- 离线可用
- 历史数据完整（10年+）

**配置**：
```bash
STOCK_DATA_DIR=/path/to/your/stock_data
```

**初始化数据**：
```bash
cd aitrader_core
python update_daily_stock_data.py
```

### 2. Tushare（专业版）

**优点**：
- 数据质量最高
- 更新及时
- 支持更多指标

**配置**：
```bash
TUSHARE_TOKEN=your_token_here
```

**注意**：需要积分，建议付费用户使用

### 3. Ashare（实时）

**优点**：
- 完全免费
- 实时数据
- 无需配置

**使用**：直接在界面选择 "Ashare" 数据源

### 4. AKShare（在线）

**优点**：
- 开源免费
- 数据源丰富
- 无需 Token

**配置**：
```bash
AKSHARE_TIMEOUT=30
```

---

## 🔔 通知配置

### 企业微信通知

1. 在企业微信群中添加机器人
2. 复制 Webhook URL
3. 配置到 `.env`：

```bash
WECOM_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx
```

### 钉钉通知

1. 在钉钉群中添加自定义机器人
2. 复制 Webhook URL
3. 配置到 `.env`：

```bash
DINGTALK_WEBHOOK_URL=https://oapi.dingtalk.com/robot/send?access_token=xxxxx
```

### 通知内容

系统会在以下情况发送通知：
- 数据更新完成
- 策略信号触发
- 系统错误告警

---

## ⚙️ 高级配置

### 性能优化

```bash
# 增加缓存时间（减少API调用）
CACHE_TTL_MINUTES=60

# 降低请求频率（避免被限流）
MAX_REQUESTS_PER_MINUTE=10
```

### 日志配置

```bash
# 开启调试日志
LOG_LEVEL=DEBUG

# 增加日志保留时间
LOG_RETENTION_DAYS=90
```

### 数据库配置（未来扩展）

```bash
# SQLite 数据库
DATABASE_URL=sqlite:///data/stocks.db

# Redis 缓存
REDIS_URL=redis://localhost:6379/0
```

---

## ❓ 常见问题

### Q1: Token 配置后仍然提示未设置？

**A**: 检查以下几点：
1. `.env` 文件是否在项目根目录
2. 文件名是否正确（不是 `.env.txt`）
3. Token 前后是否有空格
4. 是否重启了应用

### Q2: 如何验证配置是否生效？

**A**: 运行配置检查脚本：
```bash
python -c "from modules.config_manager import Config; Config.print_config()"
```

### Q3: 数据更新失败怎么办？

**A**: 
1. 检查 Tushare Token 是否有效
2. 检查网络连接
3. 查看日志文件：`logs/error_*.log`
4. 降低请求频率：`MAX_REQUESTS_PER_MINUTE=10`

### Q4: 如何在 Docker 中使用？

**A**: 
1. 创建 `.env` 文件
2. 在 `docker-compose.yml` 中引用：
```yaml
services:
  app:
    env_file:
      - .env
```

### Q5: 如何在 Streamlit Cloud 部署？

**A**: 
1. 在 Streamlit Cloud 设置中添加 Secrets
2. 格式：
```toml
TUSHARE_TOKEN = "your_token_here"
```

### Q6: 缓存占用空间太大怎么办？

**A**: 
1. 手动清理：删除 `data_cache` 目录
2. 减少缓存时间：`CACHE_TTL_MINUTES=15`
3. 在界面使用"清理缓存"功能

---

## 🔒 安全建议

1. **不要提交 `.env` 文件到 Git**
   - 已在 `.gitignore` 中配置
   - 定期检查：`git status`

2. **定期更换 Token**
   - 建议每 3-6 个月更换一次
   - 如果泄露立即更换

3. **限制 Token 权限**
   - 只授予必要的 API 权限
   - 使用只读 Token

4. **备份配置文件**
   - 将 `.env` 备份到安全位置
   - 不要上传到公共云盘

---

## 📚 相关文档

- [README.md](./README.md) - 项目总览
- [数据源使用说明.md](./数据源使用说明.md) - 数据源详细说明
- [自定义策略编辑器使用指南.md](./自定义策略编辑器使用指南.md) - 策略开发指南

---

## 💡 最佳实践

### 开发环境

```bash
# .env
DEBUG=True
LOG_LEVEL=DEBUG
CACHE_TTL_MINUTES=5
MAX_REQUESTS_PER_MINUTE=20
```

### 生产环境

```bash
# .env
DEBUG=False
LOG_LEVEL=INFO
CACHE_TTL_MINUTES=30
MAX_REQUESTS_PER_MINUTE=15
LOG_RETENTION_DAYS=30
```

### 测试环境

```bash
# .env.test
DEBUG=True
LOG_LEVEL=DEBUG
CACHE_TTL_MINUTES=1
STOCK_DATA_DIR=./test_data
```

---

## 🆘 获取帮助

如果遇到问题：

1. 查看日志：`logs/error_*.log`
2. 运行诊断：`python -m modules.config_manager`
3. 提交 Issue：[GitHub Issues](https://github.com/Ecustkiller/aytradingstragegy/issues)
4. 联系作者：[@Ecustkiller](https://github.com/Ecustkiller)

---

**最后更新**：2025-01-13
