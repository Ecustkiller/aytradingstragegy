# ğŸ—ï¸ æ•°æ®æºæ¶æ„ä¼˜åŒ–è¯´æ˜

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡æ¶æ„ä¼˜åŒ–ä¸»è¦é’ˆå¯¹æ•°æ®æºæ¨¡å—è¿›è¡Œé‡æ„ï¼Œå®ç°äº†ç»Ÿä¸€çš„æ•°æ®æºæ¥å£å’Œå·¥å‚æ¨¡å¼ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

1. **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰æ•°æ®æºå®ç°ç›¸åŒçš„æ¥å£ï¼Œä¾¿äºåˆ‡æ¢å’Œæ‰©å±•
2. **è§£è€¦åˆ**ï¼šä¸šåŠ¡é€»è¾‘ä¸å…·ä½“æ•°æ®æºå®ç°è§£è€¦
3. **æ˜“ç»´æŠ¤**ï¼šæ¸…æ™°çš„æ¶æ„å±‚æ¬¡ï¼Œä¾¿äºç»´æŠ¤å’Œè°ƒè¯•
4. **å‘åå…¼å®¹**ï¼šä¿æŒæ—§ä»£ç çš„å…¼å®¹æ€§ï¼Œå¹³æ»‘è¿ç§»

---

## ğŸ›ï¸ æ–°æ¶æ„è®¾è®¡

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä¸šåŠ¡å±‚ (bt_engine.pyç­‰)          â”‚
â”‚    ä½¿ç”¨DataSourceFactoryè·å–æ•°æ®         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      DataSourceFactory (å·¥å‚ç±»)         â”‚
â”‚    ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ•°æ®æºï¼Œæä¾›ç®€å•æ¥å£      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ Tushare  â”‚ â”‚AKShare â”‚ â”‚  CSV   â”‚ â”‚ Ashare â”‚
â”‚ Adapter  â”‚ â”‚Adapter â”‚ â”‚ Adapterâ”‚ â”‚Adapter â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚          â”‚          â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚         BaseDataSource (æŠ½è±¡åŸºç±»)           â”‚
â”‚      å®šä¹‰ç»Ÿä¸€çš„æ•°æ®æºæ¥å£è§„èŒƒ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. BaseDataSource (æŠ½è±¡åŸºç±»)

**æ–‡ä»¶**: `aitrader_core/datafeed/base_datasource.py`

**èŒè´£**:
- å®šä¹‰æ‰€æœ‰æ•°æ®æºå¿…é¡»å®ç°çš„æ¥å£
- æä¾›é€šç”¨çš„å·¥å…·æ–¹æ³•ï¼ˆæ—¥æœŸæ ‡å‡†åŒ–ã€æ•°æ®æ ¼å¼åŒ–ç­‰ï¼‰
- å®ç°é»˜è®¤çš„æ‰¹é‡è·å–é€»è¾‘

**æ ¸å¿ƒæ–¹æ³•**:
```python
class BaseDataSource(ABC):
    @abstractmethod
    def get_stock_data(symbol, start_date, end_date) -> DataFrame
    
    @abstractmethod
    def get_index_data(symbol, start_date, end_date) -> DataFrame
    
    @abstractmethod
    def get_fund_data(symbol, start_date, end_date) -> DataFrame
    
    def get_data_auto(symbol, start_date, end_date) -> DataFrame
    def get_multiple_data(symbols, start_date, end_date) -> DataFrame
```

#### 2. TushareDataSource (Tushareé€‚é…å™¨)

**æ–‡ä»¶**: `aitrader_core/datafeed/tushare_loader.py`

**çŠ¶æ€**: âœ… å·²å®Œæˆé‡æ„

**ç‰¹ç‚¹**:
- ç»§æ‰¿BaseDataSource
- å®ç°æ‰€æœ‰æŠ½è±¡æ–¹æ³•
- ä¿æŒå‘åå…¼å®¹ï¼ˆæä¾›æ—§çš„å‡½æ•°æ¥å£ï¼‰

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# æ–°æ¥å£ï¼ˆæ¨èï¼‰
from aitrader_core.datafeed.tushare_loader import TushareDataSource

datasource = TushareDataSource()
df = datasource.get_stock_data('600519.SH', '2023-01-01', '2023-12-31')

# æ—§æ¥å£ï¼ˆå‘åå…¼å®¹ï¼‰
from aitrader_core.datafeed.tushare_loader import get_stock_data

df = get_stock_data('600519.SH', '20230101', '20231231')
```

#### 3. DataSourceFactory (æ•°æ®æºå·¥å‚)

**æ–‡ä»¶**: `aitrader_core/datafeed/datasource_factory.py`

**èŒè´£**:
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ•°æ®æºå®ä¾‹
- æä¾›ç®€å•çš„æ•°æ®è·å–æ¥å£
- è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ•°æ®æº

**æ ¸å¿ƒæ–¹æ³•**:
```python
class DataSourceFactory:
    @classmethod
    def get_data(symbols, start_date, end_date, source_type) -> DataFrame
    
    @classmethod
    def list_available_sources() -> List[str]
    
    @classmethod
    def get_source_info() -> Dict
```

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from aitrader_core.datafeed.datasource_factory import DataSourceFactory

# è·å–æ•°æ®
df = DataSourceFactory.get_data(
    symbols=['600519.SH', '000001.SZ'],
    start_date='2023-01-01',
    end_date='2023-12-31',
    source_type='Tushare'
)

# åˆ—å‡ºå¯ç”¨æ•°æ®æº
sources = DataSourceFactory.list_available_sources()
print(sources)  # ['Tushare', 'AKShare', 'CSV', 'Ashare']
```

---

## ğŸ“Š æ•°æ®æºå¯¹æ¯”

| æ•°æ®æº | é‡æ„çŠ¶æ€ | æ¥å£ç±»å‹ | ç‰¹ç‚¹ | æ¨èåœºæ™¯ |
|--------|---------|---------|------|---------|
| **Tushare** | âœ… å·²å®Œæˆ | æ–°æ¥å£ | é«˜è´¨é‡ã€ä¸“ä¸š | ç²¾ç¡®å›æµ‹ |
| **AKShare** | ğŸ”„ å¾…é‡æ„ | æ—§æ¥å£ | å…è´¹ã€å¤šæº | å¿«é€ŸéªŒè¯ |
| **CSV** | ğŸ”„ å¾…é‡æ„ | æ—§æ¥å£ | å¿«é€Ÿã€ç¦»çº¿ | æ‰¹é‡å›æµ‹ |
| **Ashare** | ğŸ”„ å¾…é‡æ„ | æ—§æ¥å£ | å®æ—¶ã€å…è´¹ | å®æ—¶ç›‘æ§ |

---

## ğŸ”„ è¿ç§»æŒ‡å—

### ä¸šåŠ¡ä»£ç è¿ç§»

#### æ–¹å¼1ï¼šä½¿ç”¨DataSourceFactoryï¼ˆæ¨èï¼‰

**æ—§ä»£ç **:
```python
from aitrader_core.datafeed.tushare_loader import get_stock_data

df = get_stock_data('600519.SH', '20230101', '20231231')
```

**æ–°ä»£ç **:
```python
from aitrader_core.datafeed.datasource_factory import DataSourceFactory

df = DataSourceFactory.get_data(
    symbols=['600519.SH'],
    start_date='2023-01-01',
    end_date='2023-12-31',
    source_type='Tushare'
)
```

**ä¼˜åŠ¿**:
- ç»Ÿä¸€æ¥å£ï¼Œæ˜“äºåˆ‡æ¢æ•°æ®æº
- è‡ªåŠ¨å¤„ç†å¤šä¸ªè¯åˆ¸ä»£ç 
- æ›´å¥½çš„é”™è¯¯å¤„ç†

#### æ–¹å¼2ï¼šç›´æ¥ä½¿ç”¨æ•°æ®æºå®ä¾‹

**æ–°ä»£ç **:
```python
from aitrader_core.datafeed.tushare_loader import TushareDataSource

datasource = TushareDataSource()
if datasource.is_available():
    df = datasource.get_stock_data('600519.SH', '2023-01-01', '2023-12-31')
```

**ä¼˜åŠ¿**:
- æ›´ç»†ç²’åº¦çš„æ§åˆ¶
- å¯ä»¥å¤ç”¨æ•°æ®æºå®ä¾‹
- é€‚åˆéœ€è¦ç‰¹æ®Šé…ç½®çš„åœºæ™¯

#### æ–¹å¼3ï¼šä¿æŒæ—§æ¥å£ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

**æ—§ä»£ç **:
```python
from aitrader_core.datafeed.tushare_loader import get_stock_data

df = get_stock_data('600519.SH', '20230101', '20231231')
```

**è¯´æ˜**:
- æ—§æ¥å£ä»ç„¶å¯ç”¨ï¼Œå†…éƒ¨å·²é‡æ„ä¸ºæ–°æ¶æ„
- å»ºè®®é€æ­¥è¿ç§»åˆ°æ–°æ¥å£
- æœªæ¥ç‰ˆæœ¬å¯èƒ½åºŸå¼ƒæ—§æ¥å£

---

## ğŸ¨ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨å·¥å‚æ¨¡å¼

```python
from aitrader_core.datafeed.datasource_factory import DataSourceFactory

# æ¨èï¼šé€šè¿‡å·¥å‚è·å–æ•°æ®
df = DataSourceFactory.get_data(
    symbols=['600519.SH'],
    start_date='2023-01-01',
    end_date='2023-12-31',
    source_type='Tushare'
)
```

### 2. æ£€æŸ¥æ•°æ®æºå¯ç”¨æ€§

```python
from aitrader_core.datafeed.datasource_factory import DataSourceFactory

# åˆ—å‡ºå¯ç”¨æ•°æ®æº
available = DataSourceFactory.list_available_sources()

if 'Tushare' in available:
    df = DataSourceFactory.get_data(...)
else:
    # ä½¿ç”¨å¤‡ç”¨æ•°æ®æº
    df = DataSourceFactory.get_data(..., source_type='CSV')
```

### 3. ç»Ÿä¸€æ—¥æœŸæ ¼å¼

```python
# æ–°æ¶æ„è‡ªåŠ¨å¤„ç†å¤šç§æ—¥æœŸæ ¼å¼
df = DataSourceFactory.get_data(
    symbols=['600519.SH'],
    start_date='2023-01-01',    # æ”¯æŒ YYYY-MM-DD
    # start_date='20230101',    # ä¹Ÿæ”¯æŒ YYYYMMDD
    end_date='2023-12-31',
    source_type='Tushare'
)
```

### 4. æ‰¹é‡è·å–æ•°æ®

```python
# ä¸€æ¬¡è·å–å¤šä¸ªè¯åˆ¸çš„æ•°æ®
df = DataSourceFactory.get_data(
    symbols=['600519.SH', '000001.SZ', '510300.SH'],
    start_date='2023-01-01',
    end_date='2023-12-31',
    source_type='Tushare'
)

# æ•°æ®è‡ªåŠ¨åˆå¹¶å’Œæ’åº
print(df.head())
```

---

## ğŸ”§ æ‰©å±•æ–°æ•°æ®æº

### æ­¥éª¤1ï¼šåˆ›å»ºé€‚é…å™¨ç±»

```python
from aitrader_core.datafeed.base_datasource import BaseDataSource
from typing import Optional
import pandas as pd

class MyDataSource(BaseDataSource):
    def __init__(self):
        super().__init__(name="MyDataSource")
    
    def _initialize(self) -> bool:
        # åˆå§‹åŒ–é€»è¾‘
        try:
            # è¿æ¥æ•°æ®æº
            self._is_available = True
            return True
        except Exception as e:
            self._is_available = False
            return False
    
    def get_stock_data(self, symbol, start_date, end_date, **kwargs) -> Optional[pd.DataFrame]:
        # å®ç°è·å–è‚¡ç¥¨æ•°æ®çš„é€»è¾‘
        df = ...  # è·å–æ•°æ®
        return self.standardize_dataframe(df, symbol)
    
    def get_index_data(self, symbol, start_date, end_date, **kwargs) -> Optional[pd.DataFrame]:
        # å®ç°è·å–æŒ‡æ•°æ•°æ®çš„é€»è¾‘
        pass
    
    def get_fund_data(self, symbol, start_date, end_date, **kwargs) -> Optional[pd.DataFrame]:
        # å®ç°è·å–åŸºé‡‘æ•°æ®çš„é€»è¾‘
        pass
```

### æ­¥éª¤2ï¼šæ³¨å†Œåˆ°å·¥å‚

åœ¨ `datasource_factory.py` çš„ `initialize()` æ–¹æ³•ä¸­æ·»åŠ :

```python
# åˆå§‹åŒ–MyDataSource
try:
    from aitrader_core.datafeed.my_datasource import MyDataSource
    cls._instances['MyDataSource'] = MyDataSource()
    logger.info(f"  {cls._instances['MyDataSource']}")
except Exception as e:
    logger.warning(f"  âš ï¸ MyDataSourceåˆå§‹åŒ–å¤±è´¥: {e}")
```

### æ­¥éª¤3ï¼šä½¿ç”¨æ–°æ•°æ®æº

```python
df = DataSourceFactory.get_data(
    symbols=['600519.SH'],
    start_date='2023-01-01',
    end_date='2023-12-31',
    source_type='MyDataSource'
)
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®ç¼“å­˜

```python
from functools import lru_cache

@lru_cache(maxsize=128)
def get_cached_data(symbol, start_date, end_date, source_type):
    return DataSourceFactory.get_data([symbol], start_date, end_date, source_type)
```

### 2. æ‰¹é‡è·å–

```python
# æ¨èï¼šä¸€æ¬¡è·å–å¤šä¸ª
df = DataSourceFactory.get_data(
    symbols=['600519.SH', '000001.SZ', '510300.SH'],
    ...
)

# ä¸æ¨èï¼šå¤šæ¬¡å•ç‹¬è·å–
for symbol in symbols:
    df = DataSourceFactory.get_data([symbol], ...)
```

### 3. é€‰æ‹©åˆé€‚çš„æ•°æ®æº

- **å†å²å›æµ‹**: ä½¿ç”¨CSVï¼ˆæœ€å¿«ï¼‰
- **å®æ—¶ç›‘æ§**: ä½¿ç”¨Ashareï¼ˆå®æ—¶æ€§å¥½ï¼‰
- **ç²¾ç¡®ç ”ç©¶**: ä½¿ç”¨Tushareï¼ˆè´¨é‡æœ€é«˜ï¼‰
- **å¿«é€ŸéªŒè¯**: ä½¿ç”¨AKShareï¼ˆå…è´¹ä¾¿æ·ï¼‰

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ—§ä»£ç è¿˜èƒ½ç”¨å—ï¼Ÿ

**A**: å¯ä»¥ã€‚æ‰€æœ‰æ—§æ¥å£éƒ½ä¿æŒå…¼å®¹ï¼Œä½†å»ºè®®é€æ­¥è¿ç§»åˆ°æ–°æ¥å£ã€‚

### Q2: å¦‚ä½•åˆ‡æ¢æ•°æ®æºï¼Ÿ

**A**: åªéœ€ä¿®æ”¹ `source_type` å‚æ•°ï¼š

```python
# ä»Tushareåˆ‡æ¢åˆ°CSV
df = DataSourceFactory.get_data(..., source_type='CSV')
```

### Q3: æ•°æ®æ ¼å¼æ˜¯å¦ç»Ÿä¸€ï¼Ÿ

**A**: æ˜¯çš„ã€‚æ‰€æœ‰æ•°æ®æºè¿”å›çš„DataFrameéƒ½åŒ…å«ç›¸åŒçš„åˆ—ï¼š
- `date`: æ—¥æœŸï¼ˆdatetimeç±»å‹ï¼‰
- `open`: å¼€ç›˜ä»·
- `high`: æœ€é«˜ä»·
- `low`: æœ€ä½ä»·
- `close`: æ”¶ç›˜ä»·
- `volume`: æˆäº¤é‡
- `symbol`: è¯åˆ¸ä»£ç 

### Q4: å¦‚ä½•å¤„ç†æ•°æ®æºä¸å¯ç”¨çš„æƒ…å†µï¼Ÿ

**A**: ä½¿ç”¨å·¥å‚æ¨¡å¼è‡ªåŠ¨é™çº§ï¼š

```python
# ä¼˜å…ˆä½¿ç”¨Tushareï¼Œä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°CSV
preferred_sources = ['Tushare', 'CSV', 'AKShare']

for source in preferred_sources:
    if source in DataSourceFactory.list_available_sources():
        df = DataSourceFactory.get_data(..., source_type=source)
        if not df.empty:
            break
```

---

## ğŸ“ å¾…å®Œæˆä»»åŠ¡

- [ ] é‡æ„AKShareæ•°æ®æºé€‚é…å™¨
- [ ] é‡æ„CSVæ•°æ®æºé€‚é…å™¨
- [ ] é‡æ„Ashareæ•°æ®æºé€‚é…å™¨
- [ ] æ›´æ–°bt_engine.pyä½¿ç”¨æ–°æ¶æ„
- [ ] æ›´æ–°custom_strategy_editor.pyä½¿ç”¨æ–°æ¶æ„
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] å®Œå–„æ–‡æ¡£å’Œç¤ºä¾‹

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶
- `aitrader_core/datafeed/base_datasource.py` - æŠ½è±¡åŸºç±»
- `aitrader_core/datafeed/datasource_factory.py` - æ•°æ®æºå·¥å‚
- `aitrader_core/datafeed/tushare_loader.py` - Tushareé€‚é…å™¨ï¼ˆå·²é‡æ„ï¼‰

### å¾…é‡æ„æ–‡ä»¶
- `aitrader_core/datafeed/akshare_loader.py` - AKShareé€‚é…å™¨
- `aitrader_core/datafeed/csv_dataloader.py` - CSVé€‚é…å™¨
- `aitrader_core/datafeed/Ashare.py` - Ashareé€‚é…å™¨

### ä¸šåŠ¡æ–‡ä»¶
- `aitrader_core/bt_engine.py` - å›æµ‹å¼•æ“
- `modules/custom_strategy_editor.py` - ç­–ç•¥ç¼–è¾‘å™¨

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡æ¶æ„ä¼˜åŒ–å®ç°äº†ï¼š

1. âœ… **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰æ•°æ®æºå®ç°ç›¸åŒçš„æ¥å£
2. âœ… **å·¥å‚æ¨¡å¼**: ç®€åŒ–æ•°æ®æºçš„åˆ›å»ºå’Œç®¡ç†
3. âœ… **å‘åå…¼å®¹**: æ—§ä»£ç æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œ
4. âœ… **æ˜“äºæ‰©å±•**: æ–°å¢æ•°æ®æºåªéœ€å®ç°åŸºç±»æ¥å£
5. âœ… **æ›´å¥½çš„é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

**ä¸‹ä¸€æ­¥**: ç»§ç»­é‡æ„å…¶ä»–æ•°æ®æºé€‚é…å™¨ï¼Œå¹¶æ›´æ–°ä¸šåŠ¡ä»£ç ä½¿ç”¨æ–°æ¶æ„ã€‚

---

**æ›´æ–°æ—¶é—´**: 2025-11-13  
**ç‰ˆæœ¬**: v2.0
