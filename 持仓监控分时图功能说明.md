# 持仓监控分时图功能说明

## 🎉 新功能：专业分时图

现在持仓监控支持查看股票的实时分时图，就像同花顺等专业软件一样！

---

## 📊 功能特点

### 1. **专业的分时图展示**
- ✅ **价格线**：白色实时价格曲线
- ✅ **均价线**：黄色虚线，显示当日均价走势
- ✅ **昨收价参考线**：灰色虚线，方便对比涨跌
- ✅ **成交量柱状图**：红涨绿跌，直观显示成交活跃度

### 2. **专业配色方案**
- 🎨 深蓝色背景（#0A0E27）- 类似同花顺的专业配色
- 🎨 白色价格线 - 清晰醒目
- 🎨 黄色均价线 - 经典配色
- 🎨 红涨绿跌 - 符合A股习惯

### 3. **实时数据更新**
- ⏱️ 1分钟级别的分时数据
- ⏱️ 显示当前价格和涨跌幅
- ⏱️ 自动计算均价线
- ⏱️ 实时成交量统计

### 4. **详细统计信息**
- 📈 最高价
- 📉 最低价
- 📊 振幅百分比
- 💰 成交量（自动转换为万/亿）

---

## 🚀 使用方法

### 方法1：在持仓监控中查看

1. **打开持仓监控页面**
   ```
   进入 Streamlit 应用 → 📊 持仓监控
   ```

2. **展开股票信息**
   - 点击任意股票的展开区域
   - 例如：📊 平安银行 (000001) - 当前价: 11.63 | 涨跌幅: +0.69%

3. **点击分时图按钮**
   - 在操作区域点击 "📈 分时图" 按钮
   - 分时图会在下方展开显示

4. **查看分时图**
   - 白色线：实时价格走势
   - 黄色虚线：当日均价
   - 灰色虚线：昨收价参考线
   - 下方柱状图：成交量（红涨绿跌）

5. **查看统计信息**
   - 最高、最低、振幅、成交量
   - 数据更新时间

6. **关闭分时图**
   - 再次点击 "📈 分时图" 按钮即可收起

### 方法2：独立测试分时图

如果想单独测试分时图功能：

```bash
cd modules
streamlit run intraday_chart.py
```

---

## 📸 界面预览

### 分时图展示效果

```
┌─────────────────────────────────────────────────────────┐
│  平安银行(000001) 分时图                                  │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  当前价: 11.63                    ┌──────────────┐      │
│  +0.08 (+0.69%)                   │ 价格  均价   │      │
│                                   └──────────────┘      │
│  12.0 ┤                                                  │
│       │     ╱‾‾╲                                        │
│  11.8 ┤    ╱    ╲    ╱‾╲                               │
│       │   ╱      ╲  ╱   ╲                              │
│  11.6 ┤  ╱        ╲╱     ╲___  ← 白色价格线            │
│       │ ╱          ╲          ╲                         │
│  11.4 ┤╱            ‾‾‾‾‾‾‾‾‾‾‾╲                       │
│       ├─────────────────────────────────────────        │
│  11.55├ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ← 昨收价（灰色虚线）  │
│       │                                                  │
├─────────────────────────────────────────────────────────┤
│  成交量                                                  │
│       │ ▌ ▌   ▌ ▌▌  ▌                                  │
│       │ ▌▌▌ ▌ ▌▌▌▌▌ ▌▌                                 │
│       └─────────────────────────────────────────        │
│         9:30    10:30    11:30    13:00    14:30       │
├─────────────────────────────────────────────────────────┤
│  最高: 11.85  │  最低: 11.45  │  振幅: 3.45%  │  成交量: 1.2亿 │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 功能亮点

### 1. 类似同花顺的专业体验

**同花顺的特点：**
- 深色背景，专业配色
- 价格线和均价线清晰对比
- 成交量红涨绿跌
- 昨收价参考线

**我们的实现：**
- ✅ 深蓝色专业背景
- ✅ 白色价格线 + 黄色均价线
- ✅ 红涨绿跌成交量柱状图
- ✅ 灰色昨收价参考线
- ✅ 实时价格和涨跌幅显示

### 2. 智能数据处理

- **自动获取1分钟数据**：最多240条（一个交易日）
- **自动计算均价**：累计成交额 / 累计成交量
- **自动格式化代码**：支持多种股票代码格式
- **自动对称Y轴**：以昨收价为中心，涨跌对称显示

### 3. 交互式图表

- **Plotly交互**：可以缩放、平移、悬停查看详情
- **悬停提示**：显示具体时间、价格、成交量
- **统一X轴**：价格图和成交量图联动

### 4. 友好的错误处理

- 非交易时间提示
- 数据获取失败提示
- 自动降级处理

---

## 🔧 技术实现

### 数据来源
- **Ashare库**：获取1分钟级别的分时数据
- **新浪接口**：实时行情数据
- **腾讯接口**：备用数据源

### 绘图技术
- **Plotly**：专业的交互式图表库
- **子图布局**：价格图 + 成交量图
- **自定义样式**：专业的深色主题

### 核心算法

#### 均价线计算
```python
# 累计成交额 = 价格 × 成交量
amount = close * volume

# 均价 = 累计成交额 / 累计成交量
avg_price = cumsum(amount) / cumsum(volume)
```

#### Y轴对称显示
```python
# 计算最大涨跌幅
max_change = max(abs(max_price - prev_close), 
                 abs(min_price - prev_close))

# 以昨收价为中心，对称显示
y_range = [prev_close - max_change * 1.1, 
           prev_close + max_change * 1.1]
```

---

## 📋 支持的股票代码格式

分时图支持多种股票代码格式：

| 格式 | 示例 | 说明 |
|------|------|------|
| 纯数字 | 000001 | 自动识别市场 |
| 纯数字 | 600519 | 自动识别市场 |
| 带前缀 | sh000001 | 上海市场 |
| 带前缀 | sz000001 | 深圳市场 |
| 聚宽格式 | 000001.XSHG | 上海市场 |
| 聚宽格式 | 600519.XSHE | 深圳市场 |

**自动识别规则：**
- 6开头 → 上海主板（sh）
- 0开头 → 深圳主板（sz）
- 3开头 → 创业板（sz）

---

## ⚠️ 注意事项

### 1. 交易时间限制
- 分时数据仅在交易时间可用
- 非交易时间可能无法获取数据
- 交易时间：周一至周五 9:30-11:30, 13:00-15:00

### 2. 数据延迟
- 数据可能有1-3分钟延迟
- 不建议用于实盘交易决策
- 仅供参考和学习使用

### 3. 网络要求
- 需要访问新浪/腾讯财经接口
- 网络不稳定可能导致数据获取失败
- 建议在网络良好的环境下使用

### 4. 性能考虑
- 分时图会加载240条1分钟数据
- 首次加载可能需要2-3秒
- 建议不要同时打开过多分时图

---

## 🎓 使用场景

### 场景1：查看今日走势
```
1. 打开持仓监控
2. 找到想查看的股票
3. 点击展开 → 点击"📈 分时图"
4. 查看今日价格走势和成交量
```

### 场景2：对比价格和均价
```
1. 查看分时图
2. 观察白色价格线和黄色均价线
3. 价格在均价上方 → 相对强势
4. 价格在均价下方 → 相对弱势
```

### 场景3：分析成交量
```
1. 查看下方成交量柱状图
2. 红色柱子 → 价格上涨时的成交
3. 绿色柱子 → 价格下跌时的成交
4. 柱子高度 → 成交活跃度
```

### 场景4：判断支撑压力
```
1. 查看昨收价参考线（灰色虚线）
2. 价格在昨收价上方 → 多头占优
3. 价格在昨收价下方 → 空头占优
4. 价格反复测试昨收价 → 关键位置
```

---

## 🔄 更新日志

### v1.0.0 (2025-11-11)
- ✅ 首次发布分时图功能
- ✅ 支持1分钟级别分时数据
- ✅ 专业的同花顺风格配色
- ✅ 价格线 + 均价线 + 成交量
- ✅ 集成到持仓监控模块
- ✅ 支持多种股票代码格式
- ✅ 交互式Plotly图表
- ✅ 详细统计信息展示

---

## 🐛 常见问题

### Q1: 为什么显示"无法获取分时数据"？
**A:** 可能的原因：
1. 当前不在交易时间
2. 网络连接问题
3. 股票代码错误
4. 数据源接口异常

**解决方法：**
- 检查是否在交易时间
- 检查网络连接
- 确认股票代码正确
- 稍后重试

### Q2: 分时图加载很慢怎么办？
**A:** 
- 分时图需要加载240条数据，首次加载需要2-3秒
- 如果超过10秒还未加载，可能是网络问题
- 建议刷新页面重试

### Q3: 均价线是如何计算的？
**A:**
```
均价 = 累计成交额 / 累计成交量
累计成交额 = Σ(价格 × 成交量)
```

### Q4: 为什么成交量显示为"万"或"亿"？
**A:**
- 自动格式化，方便阅读
- ≥1亿 → 显示为"X.XX亿"
- ≥1万 → 显示为"X.XX万"
- <1万 → 显示原始数值

### Q5: 可以查看历史分时图吗？
**A:**
- 当前版本仅支持当日分时图
- 历史分时图功能计划在后续版本添加

---

## 🚀 未来计划

### 即将推出的功能：

1. **多日分时对比**
   - 对比今日和昨日分时走势
   - 查看历史某一天的分时图

2. **技术指标叠加**
   - MACD、KDJ等指标
   - 自定义指标参数

3. **分时预警**
   - 价格突破均价线提醒
   - 成交量异常提醒

4. **分时回放**
   - 回放今日走势
   - 分析关键时间点

5. **导出功能**
   - 导出分时图为图片
   - 导出分时数据为CSV

---

## 💡 使用技巧

### 技巧1：快速查看多只股票
```
1. 依次展开多只股票
2. 点击"📈 分时图"按钮
3. 上下滚动对比走势
```

### 技巧2：结合实时行情使用
```
1. 查看实时行情数据（当前价、涨跌幅）
2. 点击分时图查看详细走势
3. 结合成交量判断趋势强度
```

### 技巧3：利用均价线判断强弱
```
- 价格持续在均价上方 → 强势
- 价格持续在均价下方 → 弱势
- 价格围绕均价波动 → 震荡
```

### 技巧4：观察成交量变化
```
- 放量上涨 → 买盘积极
- 放量下跌 → 卖盘积极
- 缩量上涨 → 惜售
- 缩量下跌 → 观望
```

---

## 📞 反馈与支持

如果您在使用过程中遇到问题或有改进建议，欢迎反馈！

**功能建议：**
- 希望添加什么新功能？
- 界面有什么需要改进的地方？
- 数据展示是否清晰？

**问题反馈：**
- 遇到了什么错误？
- 在什么情况下出现的？
- 错误信息是什么？

---

**文档版本：** v1.0.0  
**更新时间：** 2025-11-11  
**功能状态：** ✅ 已完成并可用
