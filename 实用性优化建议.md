# ğŸ¯ å®ç”¨æ€§ä¼˜åŒ–å»ºè®®

## ğŸ“Š å½“å‰é—®é¢˜åˆ†æ

### 1. æ•°æ®åŠ è½½ä½“éªŒé—®é¢˜ âš ï¸

**é—®é¢˜ï¼š**
- æ•°æ®åŠ è½½æ—¶æ²¡æœ‰è¿›åº¦æç¤ºï¼Œç”¨æˆ·ä¸çŸ¥é“æ˜¯å¦åœ¨åŠ è½½
- ç½‘ç»œæ…¢æ—¶ç”¨æˆ·å¯èƒ½è¯¯ä»¥ä¸ºç¨‹åºå¡æ­»
- æ‰¹é‡è·å–æ•°æ®æ—¶æ²¡æœ‰è¿›åº¦æ˜¾ç¤º

**å½±å“ï¼š**
- ç”¨æˆ·ä½“éªŒå·®ï¼Œä¸çŸ¥é“ç¨‹åºæ˜¯å¦åœ¨å·¥ä½œ
- å¯èƒ½é‡å¤ç‚¹å‡»å¯¼è‡´é‡å¤è¯·æ±‚

**å»ºè®®ï¼š**
```python
# æ·»åŠ åŠ è½½æç¤º
with st.spinner("æ­£åœ¨è·å–è‚¡ç¥¨æ•°æ®..."):
    df = get_stock_data(...)

# æ‰¹é‡è·å–æ—¶æ˜¾ç¤ºè¿›åº¦
progress_bar = st.progress(0)
for i, symbol in enumerate(symbols):
    df = get_stock_data(symbol, ...)
    progress_bar.progress((i + 1) / len(symbols))
```

---

### 2. é”™è¯¯å¤„ç†ä¸å¤Ÿå‹å¥½ âš ï¸

**é—®é¢˜ï¼š**
- é”™è¯¯ä¿¡æ¯å¤ªæŠ€æœ¯åŒ–ï¼Œç”¨æˆ·çœ‹ä¸æ‡‚
- å¤±è´¥æ—¶æ²¡æœ‰è§£å†³å»ºè®®
- æ•°æ®æºå¤±è´¥æ—¶è™½ç„¶æœ‰å›é€€ï¼Œä½†ç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ

**å½“å‰ä»£ç ï¼š**
```python
except Exception as e:
    st.error(f"è·å–è‚¡ç¥¨æ•°æ®å¤±è´¥: {str(e)}")
    return pd.DataFrame()
```

**å»ºè®®ï¼š**
```python
except Exception as e:
    error_msg = _format_user_friendly_error(e, symbol, data_source)
    st.error(error_msg)
    st.info("ğŸ’¡ å»ºè®®ï¼šå°è¯•åˆ‡æ¢æ•°æ®æºæˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥")
    return pd.DataFrame()
```

---

### 3. æ•°æ®éªŒè¯ä¸å¤Ÿå®Œå–„ âš ï¸

**é—®é¢˜ï¼š**
- è‚¡ç¥¨ä»£ç æ ¼å¼éªŒè¯ä¸å¤Ÿä¸¥æ ¼
- æ—¥æœŸèŒƒå›´éªŒè¯ä¸å¤Ÿå®Œå–„ï¼ˆå¦‚æœªæ¥æ—¥æœŸã€æ—¥æœŸå€’åºï¼‰
- æ²¡æœ‰æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ï¼ˆç¼ºå¤±åˆ—ã€å¼‚å¸¸å€¼ï¼‰

**å»ºè®®ï¼š**
```python
def validate_stock_code(symbol: str) -> bool:
    """éªŒè¯è‚¡ç¥¨ä»£ç æ ¼å¼"""
    # 6ä½æ•°å­—ï¼Œä¸”ç¬¦åˆAè‚¡è§„åˆ™
    if not symbol.isdigit() or len(symbol) != 6:
        return False
    # æ£€æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
    code_int = int(symbol)
    if code_int < 600000 or (code_int > 900000 and code_int < 1000000):
        return False
    return True

def validate_date_range(start, end) -> tuple[bool, str]:
    """éªŒè¯æ—¥æœŸèŒƒå›´"""
    if end < start:
        return False, "ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ"
    if end > datetime.now():
        return False, "ç»“æŸæ—¥æœŸä¸èƒ½æ˜¯æœªæ¥æ—¥æœŸ"
    if (end - start).days > 365 * 5:
        return False, "æ—¥æœŸèŒƒå›´ä¸èƒ½è¶…è¿‡5å¹´"
    return True, ""
```

---

### 4. æ•°æ®æºå¤±è´¥æ—¶ç¼ºå°‘é‡è¯•æœºåˆ¶ âš ï¸

**é—®é¢˜ï¼š**
- æ•°æ®æºå¤±è´¥æ—¶ç›´æ¥å›é€€ï¼Œæ²¡æœ‰é‡è¯•
- ç½‘ç»œä¸´æ—¶æ•…éšœæ—¶ä¹Ÿä¼šç«‹å³åˆ‡æ¢æ•°æ®æº

**å»ºè®®ï¼š**
```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10)
)
def get_stock_data_with_retry(symbol, start, end, period_type, data_source):
    """å¸¦é‡è¯•çš„æ•°æ®è·å–"""
    try:
        return get_stock_data(symbol, start, end, period_type, data_source)
    except Exception as e:
        logger.warning(f"æ•°æ®è·å–å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•: {e}")
        raise
```

---

### 5. ç¼ºå°‘æ•°æ®è´¨é‡æç¤º âš ï¸

**é—®é¢˜ï¼š**
- ç”¨æˆ·ä¸çŸ¥é“æ•°æ®æ˜¯å¦æœ€æ–°
- ä¸çŸ¥é“æ•°æ®æ˜¯å¦å®Œæ•´
- ä¸çŸ¥é“æ•°æ®æ˜¯å¦æœ‰å»¶è¿Ÿ

**å»ºè®®ï¼š**
```python
def check_data_quality(df: pd.DataFrame) -> Dict[str, Any]:
    """æ£€æŸ¥æ•°æ®è´¨é‡"""
    quality = {
        'is_latest': False,
        'is_complete': False,
        'has_delay': False,
        'missing_days': 0,
        'warnings': []
    }
    
    if df.empty:
        return quality
    
    # æ£€æŸ¥æ˜¯å¦åŒ…å«æœ€æ–°äº¤æ˜“æ—¥
    latest_trading_day = get_latest_trading_day()
    if latest_trading_day in df.index:
        quality['is_latest'] = True
    else:
        quality['has_delay'] = True
        quality['warnings'].append("æ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°çš„")
    
    # æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
    expected_days = (df.index[-1] - df.index[0]).days
    actual_days = len(df)
    if actual_days < expected_days * 0.9:
        quality['is_complete'] = False
        quality['missing_days'] = expected_days - actual_days
        quality['warnings'].append(f"æ•°æ®å¯èƒ½ä¸å®Œæ•´ï¼Œç¼ºå¤±çº¦ {quality['missing_days']} å¤©")
    
    return quality
```

---

### 6. ç¼“å­˜ç­–ç•¥å¯ä»¥æ›´æ™ºèƒ½ âš ï¸

**é—®é¢˜ï¼š**
- ç¼“å­˜æ—¶é—´å›ºå®šï¼Œä¸å¤Ÿçµæ´»
- çƒ­é—¨è‚¡ç¥¨å’Œå†·é—¨è‚¡ç¥¨ä½¿ç”¨ç›¸åŒçš„ç¼“å­˜æ—¶é—´
- æ²¡æœ‰ç¼“å­˜é¢„çƒ­æœºåˆ¶

**å»ºè®®ï¼š**
```python
def get_cache_ttl(symbol: str, period_type: str) -> int:
    """æ ¹æ®è‚¡ç¥¨å’Œå‘¨æœŸç±»å‹è¿”å›ç¼“å­˜æ—¶é—´"""
    # çƒ­é—¨è‚¡ç¥¨ç¼“å­˜æ—¶é—´æ›´é•¿
    hot_stocks = ['600519', '000858', '002415']
    if symbol in hot_stocks:
        return 3600 * 2  # 2å°æ—¶
    
    # æ—¥çº¿æ•°æ®ç¼“å­˜æ—¶é—´æ›´é•¿
    if period_type == 'daily':
        return 3600  # 1å°æ—¶
    else:
        return 1800  # 30åˆ†é’Ÿ
```

---

### 7. æ‰¹é‡è·å–æ—¶ç¼ºå°‘è¿›åº¦åé¦ˆ âš ï¸

**é—®é¢˜ï¼š**
- `get_multiple_stocks_data_async` æ²¡æœ‰è¿›åº¦æ˜¾ç¤º
- ç”¨æˆ·ä¸çŸ¥é“è¿˜éœ€è¦ç­‰å¾…å¤šä¹…

**å»ºè®®ï¼š**
```python
async def get_multiple_stocks_data_async(
    symbols: List[str],
    start,
    end,
    period_type: str,
    data_source: str = "Ashare",
    progress_callback: Optional[Callable] = None
) -> Dict[str, pd.DataFrame]:
    """æ‰¹é‡è·å–è‚¡ç¥¨æ•°æ®ï¼ˆå¼‚æ­¥ï¼Œå¸¦è¿›åº¦å›è°ƒï¼‰"""
    results = {}
    total = len(symbols)
    
    for i, symbol in enumerate(symbols):
        # æ›´æ–°è¿›åº¦
        if progress_callback:
            progress_callback(i + 1, total, symbol)
        
        # è·å–æ•°æ®
        result = await asyncio.to_thread(
            _fetch_single_stock_sync,
            symbol, start, end, period_type, data_source
        )
        
        if result['status'] == 'success':
            results[symbol] = result['data']
    
    return results
```

---

### 8. è‚¡ç¥¨ä»£ç è¾“å…¥ä½“éªŒå¯ä»¥æ›´å¥½ âš ï¸

**é—®é¢˜ï¼š**
- ç”¨æˆ·è¾“å…¥è‚¡ç¥¨ä»£ç æ—¶æ²¡æœ‰è‡ªåŠ¨è¡¥å…¨
- æ²¡æœ‰è‚¡ç¥¨åç§°æç¤º
- è¾“å…¥é”™è¯¯ä»£ç æ—¶æç¤ºä¸å¤Ÿå‹å¥½

**å»ºè®®ï¼š**
```python
def stock_code_input_with_autocomplete():
    """å¸¦è‡ªåŠ¨è¡¥å…¨çš„è‚¡ç¥¨ä»£ç è¾“å…¥"""
    # ä½¿ç”¨ st.selectbox æˆ– st_autocomplete
    from streamlit_autocomplete import st_autocomplete
    
    stock_list = get_stock_list()  # è·å–è‚¡ç¥¨åˆ—è¡¨
    selected = st_autocomplete(
        "è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°",
        stock_list,
        key="stock_input"
    )
    return selected
```

---

### 9. æ•°æ®åŠ è½½è¶…æ—¶å¤„ç† âš ï¸

**é—®é¢˜ï¼š**
- æ²¡æœ‰è¶…æ—¶è®¾ç½®ï¼Œç½‘ç»œæ…¢æ—¶ä¼šä¸€ç›´ç­‰å¾…
- ç”¨æˆ·ä¸çŸ¥é“æ˜¯ç½‘ç»œé—®é¢˜è¿˜æ˜¯ç¨‹åºé—®é¢˜

**å»ºè®®ï¼š**
```python
from concurrent.futures import TimeoutError as FutureTimeoutError

def get_stock_data_with_timeout(symbol, start, end, period_type, data_source, timeout=30):
    """å¸¦è¶…æ—¶çš„æ•°æ®è·å–"""
    try:
        with ThreadPoolExecutor() as executor:
            future = executor.submit(
                get_stock_data, symbol, start, end, period_type, data_source
            )
            df = future.result(timeout=timeout)
            return df
    except FutureTimeoutError:
        st.error(f"â±ï¸ æ•°æ®è·å–è¶…æ—¶ï¼ˆ{timeout}ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•")
        return pd.DataFrame()
```

---

### 10. æ•°æ®æºé€‰æ‹©å»ºè®® âš ï¸

**é—®é¢˜ï¼š**
- ç”¨æˆ·ä¸çŸ¥é“å“ªä¸ªæ•°æ®æºæœ€é€‚åˆ
- æ²¡æœ‰æ•°æ®æºæ€§èƒ½å¯¹æ¯”

**å»ºè®®ï¼š**
```python
def recommend_data_source(symbol: str, period_type: str) -> str:
    """æ¨èæœ€é€‚åˆçš„æ•°æ®æº"""
    # æ ¹æ®è‚¡ç¥¨ç±»å‹å’Œå‘¨æœŸæ¨è
    if period_type == 'daily':
        if has_ashare:
            return "Ashare"  # æ—¥çº¿æ•°æ®æ¨èAshare
        else:
            return "AKShare"
    elif period_type == 'weekly':
        return "Tushare" if has_tushare else "AKShare"
    else:
        return "AKShare"
```

---

## ğŸ¯ ä¼˜åŒ–ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰

1. **æ·»åŠ åŠ è½½æç¤º** - æå‡ç”¨æˆ·ä½“éªŒ
2. **æ”¹è¿›é”™è¯¯ä¿¡æ¯** - è®©ç”¨æˆ·çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ
3. **æ·»åŠ æ•°æ®éªŒè¯** - é¿å…æ— æ•ˆè¯·æ±‚

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆè¿‘æœŸå®æ–½ï¼‰

4. **æ·»åŠ é‡è¯•æœºåˆ¶** - æé«˜æˆåŠŸç‡
5. **æ•°æ®è´¨é‡æ£€æŸ¥** - è®©ç”¨æˆ·äº†è§£æ•°æ®çŠ¶æ€
6. **æ‰¹é‡è·å–è¿›åº¦** - æå‡æ‰¹é‡æ“ä½œä½“éªŒ

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸè§„åˆ’ï¼‰

7. **æ™ºèƒ½ç¼“å­˜ç­–ç•¥** - ä¼˜åŒ–æ€§èƒ½
8. **è‚¡ç¥¨ä»£ç è‡ªåŠ¨è¡¥å…¨** - æå‡è¾“å…¥ä½“éªŒ
9. **è¶…æ—¶å¤„ç†** - é¿å…é•¿æ—¶é—´ç­‰å¾…
10. **æ•°æ®æºæ¨è** - å¸®åŠ©ç”¨æˆ·é€‰æ‹©

---

## ğŸ’¡ å®æ–½å»ºè®®

1. **æ¸è¿›å¼ä¼˜åŒ–** - å…ˆåšé«˜ä¼˜å…ˆçº§ï¼Œé€æ­¥å®Œå–„
2. **ç”¨æˆ·åé¦ˆ** - æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´
3. **æ€§èƒ½ç›‘æ§** - è·Ÿè¸ªä¼˜åŒ–æ•ˆæœ

---

**é¢„è®¡æ•ˆæœï¼š**
- ç”¨æˆ·ä½“éªŒï¼šæå‡ 50%+
- é”™è¯¯ç‡ï¼šé™ä½ 30%+
- ç”¨æˆ·æ»¡æ„åº¦ï¼šæå‡ 40%+

